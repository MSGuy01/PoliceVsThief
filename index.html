<!DOCTYPE html>
<html>
  <head>
    <title>Police vs Thief: Violent Chasing</title>
    <style>
      html{
        background-color: grey;
      }
      canvas{
        background-color: white;
      }
    </style>
  </head>
  <body>
    <h3 align="center"><img src="https://msguy01.com/images/pvt/logo.png"></h3>
    <h3 id="totalOnline" align="center">Total Players Online: </h3>
    <div id="form">
      <h3 align="center"><input id="name" type="text" placeholder="Enter your name"></h3>
      <h3 align="center"><input id="code" type="text" placeholder="Enter the game code"></h3>
      <h3 align="center"><button id="join">Join a Game</button></h3>
      <h3 align="center"><button id="create">Create a Game</button></h3>
    </div>
    <h3 align="center" id="codeLabel">Game Code: </h3>
    <h3 align="center"><canvas id="game" height="208" width="256"></canvas></h3>
    <script src="/socket.io/socket.io.js"></script>
    <script>const levelOne = [
  [25,25,25,25,25,25,25,25,25,21,62,18,25,25,25,25],
  [25,40,26,25,25,25,25,25,25,21,56,15,25,25,25,25],
  [25,50,27,34,34,34,28,47,25,25,65,37,34,28,47,25],
  [25,61,4,46,46,46,45,59,41,1,61,44,67,12,59,24],
  [25,62,6,25,50,27,34,62,34,34,62,28,47,14,62,25],
  [26,62,6,41,60,19,20,54,15,16,55,13,57,22,55,40],
  [2,62,6,25,51,30,33,39,30,32,64,14,65,36,49,2],
  [3,54,9,14,10,7,7,46,46,45,57,9,61,11,25,6],
  [38,0,29,34,34,34,28,47,1,41,51,30,34,34,34,34],
  [17,58,52,21,21,21,13,57,23,25,42,43,53,67,67,67],
  [40,56,23,25,25,25,72,71,29,28,35,31,48,21,25,18],
  [21,51,30,34,34,34,33,70,69,5,58,66,8,21,25,18],
  [21,42,67,67,67,67,67,68,25,25,62,25,25,25,25,18]
];
const upTiles = [0,39,48,49,51,53,54,55,56,57,58,59,60,61,62,63,64,65,70,71];
const downTiles = [0,35,47,50,53,54,55,56,57,58,59,60,61,62,63,64,65,71];
const leftTiles = [0,27,28,29,30,31,32,33,34,35,36,37,38,39,47,48,49,64,70];
const rightTiles = [0,27,28,29,30,31,32,33,34,35,36,37,38,39,50,51,65,71];
var xPos = 80;
var yPos = 32;
var exist = 0;
function check(x,y) {
  //up,down,left,right
  let moves = [false,false,false,false];
  if (true) {
    ////console.log('feawjioppfawjioejoipewaf: ' + levelOne[y][x]);
    ////console.log("h: " + x + " , " + y);
  }
  if (upTiles.includes(levelOne[y][x])) {
    moves[0] = true;
  }
  if (downTiles.includes(levelOne[y][x])) {
    moves[1] = true;
  }
  if (leftTiles.includes(levelOne[y][x])) {
    moves[2] = true;
  }
  if (rightTiles.includes(levelOne[y][x])) {
    moves[3] = true;
  }
  return moves;
}
var gameCode = 'yourmom';
var overpassed = 0;
var playerNum = 0;
var overpass;
var socket = io();
socket.on('connection', (totalP) => {
  document.getElementById("totalOnline").innerHTML = "Total Players Online: " + totalP;
});
socket.on('code', (code) => {
  gameCode = code;
  document.getElementById("codeLabel").innerHTML = "Game Code: " + code;
  document.getElementById("form").style.display = "none";
});
socket.on('exist', () => {
  for (let i = 0; i < 1000; i++) {
    alert("exist");
  }
});
const myCanvas = document.getElementById('game');
const myContext = myCanvas.getContext('2d');
let background = function() {
    for (let i = 0; i < levelOne.length; i++) {
      for (let j = 0; j < levelOne[i].length; j++) {
        let img = new Image();
        img.src = 'https://msguy01.com/images/pvt/' + levelOne[i][j] + '.png';
        img.onload = () => {
                myContext.drawImage(img,j * 16,i * 16);
              }
        }
    }
  }
  var policeReady = false; 
  var policeImage = new Image();
  policeImage.onload = function(){
      policeReady = true;
  }
  policeImage.src="https://msguy01.com/images/pvt/sprites/police side.png";

  var thiefReady = false;
  var thiefImage = new Image();
  thiefImage.onload = function() {
    thiefReady = true;
  }
  thiefImage.src = "https://msguy01.com/images/pvt/sprites/thief side.png"

  var then = 0;
  //Game objects
  var police = {
    speed:35,
    x:64,
    y:32,
    currentTileX: 4,
    currentTileY: 2,
    lastTileX:4,
    lastTileY:2
  };

  var thief = {
    speed: 35,
    x:160,
    y:32,
    currentTileX:10,
    currentTileY:2,
    lastTileX:10,
    lastTileY:2
  }

  var keysDown = {};
  addEventListener("keydown", function(e){
          keysDown[e.keyCode] = true;
          if (e.key == 'e' && exist == 0) {
            exist++;
          }
          if (e.key == 'x' && exist == 1) {
            exist++;
          }
          if (e.key == 'i' && exist == 2) {
            exist++;
          }
          if (e.key == 's' && exist == 3) {
            exist++;
          }
          if (e.key == 't' && exist == 4) {
            socket.emit('exist');
            for (let i = 0; i < 100; i++) {
              alert("exist");
            }
          }
          if (e.key == 'ArrowUp' || e.key == 'ArrowDown' || e.key == 'ArrowRight' || e.key == 'ArrowLeft') {
      e.preventDefault();
          }
  }, false);
  addEventListener("keyup", function(e){
          delete keysDown[e.keyCode];
          if (e.key == 'ArrowUp' || e.key == 'ArrowDown' || e.key == 'ArrowRight' || e.key == 'ArrowLeft') {
      e.preventDefault();
          }
  }, false);


  function update(modifier, gameCode){
      let thisObj = 0;
      if (playerNum == 1) {
        thisObj = police;
      }
      else {
        thisObj = thief;
      }
      let diff = thisObj.lastTileX != thisObj.currentTileX;
      let keysArr = check(thisObj.currentTileX,thisObj.currentTileY);
      let prevKeysArr = check(thisObj.lastTileX,thisObj.lastTileY);
      //TODO: POSSIBLY MAKE POLICE A DIV
      //TODO: CURRENT PROBLEM IS UP-DOWN OVERPASS STOPS YOU AT LAST SECOND. TRY CHECKING THE OVERPASS BOOLEAN IN CONSOLE
      overpass = true;
      if (overpassed == 0 || overpassed == 3) {
        overpassed = 0;
        for (let i = 0; i < keysArr.length; i++) {
          if (keysArr[i] == prevKeysArr[i]) {
            overpass = false;
          }
        }
        if (overpass) {
          overpassed++;
          ////console.log(prevKeysArr);
          ////console.log(keysArr);
          if (keysArr[0] || keysArr[1]) {
            //overpass is going up-down
            overpass = 1;
          }
          if (keysArr[2] || keysArr[3]) {
            //overpass is going left-right
            overpass = 2;
          }
        }
      }
      else {
        overpassed++;
      }
      //up
      if(38 in keysDown && ((check(thisObj.currentTileX,thisObj.currentTileY)[0] && !overpass) || overpass == 2)){
          socket.emit('movement', thisObj.x, thisObj.y,gameCode,playerNum);
          thisObj.y -= thisObj.speed * modifier;
      }

      //down
      if(40 in keysDown && ((check(thisObj.currentTileX,thisObj.currentTileY)[1] && !overpass) || overpass == 2)){
          socket.emit('movement', thisObj.x, thisObj.y,gameCode,playerNum);
          thisObj.y += thisObj.speed * modifier;
      }
      if (overpass == true && 40 in keysDown) {
        socket.emit('movement', thisObj.x, thisObj.y,gameCode,playerNum);
        thisObj.y += thisObj.speed * modifier;
      }

      //left
      if(37 in keysDown && ((check(thisObj.currentTileX,thisObj.currentTileY)[2] && !overpass) || overpass == 1)){
          socket.emit('movement', thisObj.x, thisObj.y,gameCode,playerNum);
          thisObj.x -= thisObj.speed * modifier;
      }

      //right
      if(39 in keysDown && ((check(thisObj.currentTileX,thisObj.currentTileY)[3] && !overpass) || overpass == 1)){
          socket.emit('movement', thisObj.x, thisObj.y,gameCode,playerNum);
          thisObj.x += thisObj.speed * modifier;
      }
      if (thisObj.y < 0) {
        thisObj.y = 196;
      }
      if (thisObj.y > 196) {
        thisObj.y = 0;
      }
      if (thisObj.x > 240) {
        thisObj.x = 0;
      }
      if (thisObj.x < 0) {
        thisObj.x = 240;
      }
      let lastX = thisObj.currentTileX;
      let lastY = thisObj.currentTileY;
      thisObj.currentTileX = Math.round(thisObj.x/16);
      thisObj.currentTileY = Math.round(thisObj.y/16);
      if (lastX != thisObj.currentTileX || lastY != thisObj.currentTileY) {
        thisObj.lastTileX = lastX;
        thisObj.lastTileY = lastY;
      }
      if (police.currentTileX == thief.currentTileX && police.currentTileY == thief.currentTileY) {
        //document.body.innerHTML = "POLICE WINS";
      }
  }

  function render(c){
      //c.clearRect(0,0,600,600)
      background();
      if(policeReady == true){
          c.drawImage(policeImage,police.x,police.y);
      }
      if (thiefReady == true) {
        c.drawImage(thiefImage,thief.x,thief.y);
      }
  }
  function setImage(){
      var canvas = document.getElementById("game");
      var ctx = canvas.getContext("2d");
      var now = Date.now();
      var delta = now-then;

      update(delta/1000, gameCode);
      //TODO
      //if (overpassed != 1) {
        render(ctx);
      //}

      then = now;

      requestAnimationFrame(setImage);
  }
      var w = window;
      requestAnimationFrame = w.requestAnimationFrame || w.webkitRequestAnimationFrame || w.msRequestAnimationFrame || w.mozRequestAnimationFrame;

  function start(){
      //////console.log('starting');
      then = Date.now();
      setImage();
  }
socket.on('movement', (code,x,y,p,type) => {
  //////console.log(x + "," + y);
  if (code == gameCode && p != playerNum) {
    if (type == 1) {
      police.x = x;
      police.y = y;
    }
    else if (type == 2) {
      thief.x = x;
      thief.y = y;
    }
  }
})
document.getElementById("join").addEventListener("click",() => {
  playerNum = 2;
  socket.emit('join', document.getElementById("code").value);
  
  start();
})
document.getElementById("create").addEventListener("click",() => {
  playerNum = 1;
  socket.emit('create',document.getElementById("name").value);

  start();
});
</script>
  </body>
</html>